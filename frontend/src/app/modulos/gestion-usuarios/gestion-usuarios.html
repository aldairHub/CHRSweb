<!-- src/app/modulos/gestion-usuarios/gestion-usuarios.html -->
<app-navbar></app-navbar>

<div class="main-container">
  <div class="content-wrapper">

    <!-- Header -->
    <div class="page-header">
      <div>
        <h2>Gestión de Usuarios</h2>
        <p class="page-subtitle">Administra autoridades académicas y usuarios del sistema</p>
      </div>
    </div>

    <!-- ── PESTAÑAS ─────────────────────────────────────────── -->
    <div class="tabs">
      <button class="tab-btn" [class.active]="activeTab === 'autoridades'"
              (click)="activeTab = 'autoridades'; applyFiltersAutoridades()">
        Autoridades Académicas
      </button>
      <button class="tab-btn" [class.active]="activeTab === 'usuarios'"
              (click)="activeTab = 'usuarios'; applyFiltersUsuarios()">
        Usuarios del Sistema
      </button>
    </div>

    <!-- ════════════════════════════════════════════════════════ -->
    <!-- PESTAÑA AUTORIDADES                                      -->
    <!-- ════════════════════════════════════════════════════════ -->
    <ng-container *ngIf="activeTab === 'autoridades'">

      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
            </svg>
          </div>
          <div class="stat-content">
            <h3>Total Autoridades</h3>
            <div class="stat-value">{{ autoridades.length }}</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon success">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <div class="stat-content">
            <h3>Activas</h3>
            <div class="stat-value">{{ autoridadesActivas }}</div>
          </div>
        </div>
      </div>

      <!-- Filtros -->
      <div class="filters-section">
        <div class="search-box">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none"
               viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <input type="text" class="form-input"
                 placeholder="Buscar por nombre, apellido o correo..."
                 [(ngModel)]="searchAutoridad" (input)="applyFiltersAutoridades()" />
        </div>

        <select class="form-select" [(ngModel)]="filterEstadoAutoridad"
                (change)="applyFiltersAutoridades()">
          <option value="">Todos los estados</option>
          <option value="true">Activas</option>
          <option value="false">Inactivas</option>
        </select>
      </div>

      <!-- Tabla autoridades -->
      <div class="table-container">
        <table class="table">
          <thead>
          <tr>
            <th>Autoridad</th>
            <th>Correo</th>
            <th>Usuario App</th>
            <th>Roles de Aplicación</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let a of autoridadesPaginadas">
            <td><strong>{{ a.nombres }} {{ a.apellidos }}</strong></td>
            <td>{{ a.correo }}</td>
            <td>{{ a.usuarioApp }}</td>
            <td>
              <div class="roles-container">
                <span class="badge-rol-app" *ngFor="let r of a.rolesApp">{{ r.nombre }}</span>
                <em class="text-muted" *ngIf="!a.rolesApp?.length">Sin roles</em>
              </div>
            </td>
            <td>
                <span class="badge" [ngClass]="a.estado ? 'success' : 'danger'">
                  <span class="status-dot"></span>
                  {{ a.estado ? 'Activa' : 'Inactiva' }}
                </span>
            </td>
            <td>
              <div class="action-buttons">
                <label class="toggle-switch" [title]="a.estado ? 'Desactivar' : 'Activar'">
                  <input type="checkbox" [checked]="a.estado" (change)="toggleEstadoAutoridad(a)">
                  <span class="toggle-slider"></span>
                </label>

                <button class="btn-icon" title="Editar roles" (click)="openRolesAutoridadModal(a)">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>

          <tr *ngIf="autoridadesPaginadas.length === 0">
            <td colspan="6" class="empty-state">
              <div class="empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
              </div>
              <p>No se encontraron autoridades</p>
              <small>Intenta ajustar los filtros de búsqueda</small>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- Paginación autoridades -->
      <div class="pagination" *ngIf="autoridadesFiltradas.length > 0">
        <div class="pagination-info">
          Mostrando {{ (pageAutoridad - 1) * pageSize + 1 }} -
          {{ Math.min(pageAutoridad * pageSize, autoridadesFiltradas.length) }}
          de {{ autoridadesFiltradas.length }} autoridades
        </div>
        <div class="pagination-controls">
          <button class="page-btn" [disabled]="pageAutoridad === 1"
                  (click)="pageAutoridad = pageAutoridad - 1">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
          </button>

          <button *ngFor="let p of getPageNums(totalPagesAutoridad)"
                  class="page-btn"
                  [class.active]="p === pageAutoridad"
                  (click)="pageAutoridad = p">{{ p }}</button>

          <button class="page-btn" [disabled]="pageAutoridad === totalPagesAutoridad"
                  (click)="pageAutoridad = pageAutoridad + 1">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      </div>

    </ng-container>

    <!-- ════════════════════════════════════════════════════════ -->
    <!-- PESTAÑA USUARIOS                                         -->
    <!-- ════════════════════════════════════════════════════════ -->
    <ng-container *ngIf="activeTab === 'usuarios'">

      <!-- Stats -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
            </svg>
          </div>
          <div class="stat-content">
            <h3>Total Usuarios</h3>
            <div class="stat-value">{{ usuarios.length }}</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon success">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
          </div>
          <div class="stat-content">
            <h3>Activos</h3>
            <div class="stat-value">{{ usuariosActivos }}</div>
          </div>
        </div>
      </div>

      <!-- Filtros -->
      <div class="filters-section">
        <div class="search-box">
          <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none"
               viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          <input type="text" class="form-input"
                 placeholder="Buscar por usuario o correo..."
                 [(ngModel)]="searchUsuario" (input)="applyFiltersUsuarios()" />
        </div>

        <select class="form-select" [(ngModel)]="filterEstadoUsuario"
                (change)="applyFiltersUsuarios()">
          <option value="">Todos los estados</option>
          <option value="true">Activos</option>
          <option value="false">Inactivos</option>
        </select>
      </div>

      <!-- Tabla usuarios -->
      <div class="table-container">
        <table class="table">
          <thead>
          <tr>
            <th>Usuario App</th>
            <th>Usuario BD</th>
            <th>Correo</th>
            <th>Roles de Aplicación</th>
            <th>Estado</th>
            <th>Acciones</th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let u of usuariosPaginados">
            <td><strong>{{ u.usuarioApp }}</strong></td>
            <td>{{ u.usuarioBd }}</td>
            <td>{{ u.correo }}</td>
            <td>
              <div class="roles-container">
                <span class="badge-rol-app" *ngFor="let r of u.rolesApp">{{ r.nombre }}</span>
                <em class="text-muted" *ngIf="!u.rolesApp?.length">Sin roles</em>
              </div>
            </td>
            <td>
                <span class="badge" [ngClass]="u.activo ? 'success' : 'danger'">
                  <span class="status-dot"></span>
                  {{ u.activo ? 'Activo' : 'Inactivo' }}
                </span>
            </td>
            <td>
              <div class="action-buttons">
                <label class="toggle-switch" [title]="u.activo ? 'Desactivar' : 'Activar'">
                  <input type="checkbox" [checked]="u.activo" (change)="toggleEstadoUsuario(u)">
                  <span class="toggle-slider"></span>
                </label>

                <button class="btn-icon" title="Editar roles" (click)="openRolesUsuarioModal(u)">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>

          <tr *ngIf="usuariosPaginados.length === 0">
            <td colspan="6" class="empty-state">
              <div class="empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                </svg>
              </div>
              <p>No se encontraron usuarios</p>
              <small>Intenta ajustar los filtros de búsqueda</small>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- Paginación usuarios -->
      <div class="pagination" *ngIf="usuariosFiltrados.length > 0">
        <div class="pagination-info">
          Mostrando {{ (pageUsuario - 1) * pageSize + 1 }} -
          {{ Math.min(pageUsuario * pageSize, usuariosFiltrados.length) }}
          de {{ usuariosFiltrados.length }} usuarios
        </div>
        <div class="pagination-controls">
          <button class="page-btn" [disabled]="pageUsuario === 1"
                  (click)="pageUsuario = pageUsuario - 1">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/>
            </svg>
          </button>

          <button *ngFor="let p of getPageNums(totalPagesUsuario)"
                  class="page-btn"
                  [class.active]="p === pageUsuario"
                  (click)="pageUsuario = p">{{ p }}</button>

          <button class="page-btn" [disabled]="pageUsuario === totalPagesUsuario"
                  (click)="pageUsuario = pageUsuario + 1">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
            </svg>
          </button>
        </div>
      </div>

    </ng-container>

  </div>
</div>

<!-- ════════════════ MODAL EDICIÓN DE ROLES_APP ════════════════ -->
<div class="modal-overlay" *ngIf="showRolesModal" (click)="closeRolesModal()">
  <div class="modal-content modal-sm" (click)="$event.stopPropagation()">

    <div class="modal-header">
      <h3>Editar Roles de Aplicación</h3>
      <button class="close-btn" (click)="closeRolesModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>

    <div class="modal-body">

      <!-- Info del sujeto -->
      <div class="alert info" *ngIf="rolesModalTipo === 'autoridad' && selectedAutoridad">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <div>
          <strong>{{ selectedAutoridad.nombres }} {{ selectedAutoridad.apellidos }}</strong>
          <p>{{ selectedAutoridad.usuarioApp }} · {{ selectedAutoridad.correo }}</p>
        </div>
      </div>

      <div class="alert info" *ngIf="rolesModalTipo === 'usuario' && selectedUsuario">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <div>
          <strong>{{ selectedUsuario.usuarioApp }}</strong>
          <p>{{ selectedUsuario.correo }}</p>
        </div>
      </div>

      <!-- Roles disponibles -->
      <div class="form-section">
        <div class="section-title">Roles Disponibles</div>
        <div class="section-description">Selecciona los roles de aplicación a asignar:</div>
      </div>

      <div class="roles-app-list" *ngIf="rolesAppDisponibles.length > 0; else sinRoles">
        <label class="rol-app-item" *ngFor="let r of rolesAppDisponibles">
          <input type="checkbox"
                 [checked]="isRolSelected(r.idRolApp)"
                 (change)="toggleRolApp(r.idRolApp, $event)" />
          <div class="rol-app-info">
            <div class="rol-app-nombre">{{ r.nombre }}</div>
            <div class="rol-app-desc" *ngIf="r.descripcion">{{ r.descripcion }}</div>
          </div>
        </label>
      </div>

      <ng-template #sinRoles>
        <div class="empty-state-sm">No hay roles de aplicación configurados.</div>
      </ng-template>

    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" (click)="closeRolesModal()">Cancelar</button>
      <button class="btn btn-primary" (click)="saveRoles()" [disabled]="isSaving">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
             stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
        </svg>
        {{ isSaving ? 'Guardando...' : 'Guardar Roles' }}
      </button>
    </div>

  </div>
</div>
