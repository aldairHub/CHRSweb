<!-- gestion-usuarios.component.html -->

<div class="main-container">
  <div class="content-wrapper">

    <!-- Header de la página -->
    <div class="page-header">
      <div>
        <h2>Gestión de Usuarios</h2>
        <p class="page-subtitle">Autoridades Académicas</p>
      </div>
      <button class="btn btn-primary" (click)="openCreateModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Nueva Autoridad
      </button>
    </div>

    <!-- Tarjetas de Estadísticas -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
        </div>
        <div class="stat-content">
          <h3>Total Usuarios</h3>
          <div class="stat-value">{{ totalUsuarios }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon success">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="stat-content">
          <h3>Activos</h3>
          <div class="stat-value">{{ usuariosActivos }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon purple">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
        </div>
        <div class="stat-content">
          <h3>Decanos</h3>
          <div class="stat-value">{{ totalDecanos }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon blue">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
          </svg>
        </div>
        <div class="stat-content">
          <h3>Coordinadores</h3>
          <div class="stat-value">{{ totalCoordinadores }}</div>
        </div>
      </div>
    </div>

    <!-- Filtros y Búsqueda -->
    <div class="filters-section">
      <div class="search-box">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          type="text"
          class="form-input with-icon"
          placeholder="Buscar por nombre, apellido o correo..."
          [(ngModel)]="searchTerm"
          (input)="applyFilters()"
        >
      </div>

      <select class="form-select" [(ngModel)]="filterRole" (change)="applyFilters()">
        <option value="">Todos los Roles</option>
        <option value="DECANATO_FACULTAD">Decanato</option>
        <option value="COORDINADOR_CARRERA">Coordinador</option>
        <option value="VICERRECTORADO_ACADEMICO">Vicerrectorado</option>
        <option value="CONSEJO_ACADEMICO">Consejo Académico</option>
      </select>

      <select class="form-select" [(ngModel)]="filterStatus" (change)="applyFilters()">
        <option value="">Todos los Estados</option>
        <option value="true">Activos</option>
        <option value="false">Inactivos</option>
      </select>
    </div>

    <!-- Tabla de Usuarios -->
    <div class="table-container">
      <table class="table">
        <thead>
        <tr>
          <th>Usuario App</th>
          <th>Nombre Completo</th>
          <th>Correo</th>
          <th>Roles de Autoridad</th>
          <th>Facultad/Carrera</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr *ngFor="let usuario of usuariosFiltrados">
          <td><strong>{{ usuario.usuarioApp }}</strong></td>
          <td>{{ usuario.nombres }} {{ usuario.apellidos }}</td>
          <td>{{ usuario.correo }}</td>
          <td>
            <div class="roles-container">
                <span
                  *ngFor="let rol of usuario.rolesAutoridad"
                  class="role-badge"
                  [ngClass]="getRolClass(rol)"
                >
                  {{ getRolLabel(rol) }}
                </span>
            </div>
          </td>
          <td>
            <div class="assignment-info" *ngIf="usuario.facultad || usuario.carrera">
              <div class="assignment-primary" *ngIf="usuario.facultad">
                {{ usuario.facultad.nombre }}
              </div>
              <div class="assignment-secondary" *ngIf="usuario.carrera">
                {{ usuario.carrera.nombre }}
                <span class="separator" *ngIf="usuario.facultad">•</span>
                <span *ngIf="usuario.facultad">{{ usuario.facultad.nombre }}</span>
              </div>
            </div>
            <div class="assignment-info" *ngIf="!usuario.facultad && !usuario.carrera">
              <span class="text-muted">N/A</span>
            </div>
          </td>
          <td>
              <span class="badge" [ngClass]="usuario.activo ? 'success' : 'danger'">
                <span class="status-dot"></span>
                {{ usuario.activo ? 'Activo' : 'Inactivo' }}
              </span>
          </td>
          <td>
            <div class="action-buttons">
              <label class="toggle-switch" [title]="usuario.activo ? 'Desactivar' : 'Activar'">
                <input
                  type="checkbox"
                  [checked]="usuario.activo"
                  (change)="toggleStatus(usuario)"
                >
                <span class="toggle-slider"></span>
              </label>
              <button class="btn-icon" (click)="openEditModal(usuario)" title="Editar">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>
              <button class="btn-icon" (click)="openRolesModal(usuario)" title="Ver Roles">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                </svg>
              </button>
            </div>
          </td>
        </tr>

        <tr *ngIf="usuariosFiltrados.length === 0">
          <td colspan="7" class="empty-state">
            <div class="empty-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
              </svg>
            </div>
            <p>No se encontraron usuarios</p>
            <small>Intenta ajustar los filtros de búsqueda</small>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="pagination" *ngIf="totalPages > 1">
      <div class="pagination-info">
        Mostrando {{ (currentPage - 1) * pageSize + 1 }}-{{ Math.min(currentPage * pageSize, totalUsuarios) }} de {{ totalUsuarios }}
      </div>
      <div class="pagination-controls">
        <button
          class="btn btn-sm btn-outline"
          [disabled]="currentPage === 1"
          (click)="changePage(currentPage - 1)"
        >
          Anterior
        </button>
        <button
          *ngFor="let page of getPageNumbers()"
          class="btn btn-sm"
          [ngClass]="page === currentPage ? 'btn-primary' : 'btn-outline'"
          (click)="changePage(page)"
        >
          {{ page }}
        </button>
        <button
          class="btn btn-sm btn-outline"
          [disabled]="currentPage === totalPages"
          (click)="changePage(currentPage + 1)"
        >
          Siguiente
        </button>
      </div>
    </div>

  </div>
</div>

<!-- MODAL: CREAR AUTORIDAD -->
<div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Nueva Autoridad Académica</h3>
      <button class="close-btn" (click)="closeCreateModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <!-- Info Alert -->
      <div class="alert info">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div>
          <strong>Información Importante</strong>
          <p>El sistema generará automáticamente las credenciales y enviará un correo electrónico al usuario con sus datos de acceso.</p>
        </div>
      </div>

      <form [formGroup]="createForm">
        <!-- Sección: Datos Personales -->
        <div class="form-section">
          <div class="section-title">Datos Personales</div>
          <div class="section-description">Información básica de la autoridad académica</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Nombres <span class="required">*</span></label>
            <input type="text" class="form-input" formControlName="nombres" placeholder="Ej: Juan Carlos">
            <div class="error-message" *ngIf="createForm.get('nombres')?.invalid && createForm.get('nombres')?.touched">
              Este campo es obligatorio
            </div>
          </div>

          <div class="form-group">
            <label>Apellidos <span class="required">*</span></label>
            <input type="text" class="form-input" formControlName="apellidos" placeholder="Ej: Pérez Morales">
            <div class="error-message" *ngIf="createForm.get('apellidos')?.invalid && createForm.get('apellidos')?.touched">
              Este campo es obligatorio
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Correo Electrónico <span class="required">*</span></label>
            <input type="email" class="form-input" formControlName="correo" placeholder="usuario@uteq.edu.ec">
            <small class="help-text">Se enviará las credenciales a este correo</small>
            <div class="error-message" *ngIf="createForm.get('correo')?.invalid && createForm.get('correo')?.touched">
              Ingrese un correo válido
            </div>
          </div>

          <div class="form-group">
            <label>Fecha de Nacimiento <span class="required">*</span></label>
            <input type="date" class="form-input" formControlName="fechaNacimiento">
          </div>
        </div>

        <div class="form-group">
          <label>Institución <span class="required">*</span></label>
          <select class="form-select" formControlName="idInstitucion">
            <option value="">Seleccionar institución...</option>
            <option *ngFor="let inst of instituciones" [value]="inst.id">{{ inst.nombre }}</option>
          </select>
        </div>

        <!-- Sección: Roles de Autoridad -->
        <div class="form-section">
          <div class="section-title">Roles de Autoridad</div>
          <div class="section-description">Seleccione uno o más roles (determinará los roles de usuario automáticamente)</div>
        </div>

        <div class="checkbox-grid" formArrayName="rolesAutoridad">
          <label class="checkbox-item">
            <input type="checkbox" value="DECANATO_FACULTAD" (change)="onRoleChange($event)">
            <span>Decanato de la Facultad</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" value="COORDINADOR_CARRERA" (change)="onRoleChange($event)">
            <span>Coordinador de Carrera</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" value="VICERRECTORADO_ACADEMICO" (change)="onRoleChange($event)">
            <span>Miembro de Vicerrectorado</span>
          </label>
          <label class="checkbox-item">
            <input type="checkbox" value="CONSEJO_ACADEMICO" (change)="onRoleChange($event)">
            <span>Miembro del Consejo Académico</span>
          </label>
        </div>

        <!-- Campo Condicional: Facultad -->
        <div class="conditional-field" *ngIf="needsFacultad">
          <div class="form-group">
            <label>Facultad <span class="required">*</span></label>
            <select class="form-select" formControlName="idFacultad">
              <option value="">Seleccionar facultad...</option>
              <option *ngFor="let fac of facultades" [value]="fac.id">{{ fac.nombre }}</option>
            </select>
            <small class="help-text warning">⚠️ Obligatorio al seleccionar "Decanato de la Facultad"</small>
          </div>
        </div>

        <!-- Campo Condicional: Carrera -->
        <div class="conditional-field" *ngIf="needsCarrera">
          <div class="form-group">
            <label>Carrera <span class="required">*</span></label>
            <select class="form-select" formControlName="idCarrera">
              <option value="">Seleccionar carrera...</option>
              <option *ngFor="let car of carreras" [value]="car.id">{{ car.nombre }}</option>
            </select>
            <small class="help-text warning">⚠️ Obligatorio al seleccionar "Coordinador de Carrera"</small>
          </div>
        </div>

        <!-- Preview de Roles de Usuario -->
        <div class="form-section">
          <div class="section-title">Roles de Usuario (Asignación Automática)</div>
          <div class="section-description">Estos roles se asignarán automáticamente según los roles de autoridad seleccionados</div>
        </div>

        <div class="roles-preview">
          <div *ngIf="previewRoles.length === 0" class="preview-empty">
            Seleccione roles de autoridad para ver la asignación automática...
          </div>
          <div *ngFor="let rol of previewRoles" class="role-preview-item">
            <div>
              <div class="role-name">{{ rol.nombre }}</div>
              <div class="role-description">{{ rol.descripcion }}</div>
            </div>
            <span class="auto-badge">Automático</span>
          </div>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" (click)="closeCreateModal()">Cancelar</button>
      <button class="btn btn-primary" (click)="saveAutoridad()" [disabled]="createForm.invalid || isSaving">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        {{ isSaving ? 'Guardando...' : 'Crear Autoridad' }}
      </button>
    </div>
  </div>
</div>

<!-- MODAL: EDITAR AUTORIDAD -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Editar Autoridad Académica</h3>
      <button class="close-btn" (click)="closeEditModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <form [formGroup]="editForm" *ngIf="editForm">
        <!-- Usuario (readonly) -->
        <div class="form-row">
          <div class="form-group">
            <label>Usuario App</label>
            <input type="text" class="form-input" [value]="selectedUsuario?.usuarioApp" disabled>
          </div>
          <div class="form-group">
            <label>ID Autoridad</label>
            <input type="text" class="form-input" [value]="'#' + selectedUsuario?.idAutoridad" disabled>
          </div>
        </div>

        <!-- Datos Personales -->
        <div class="form-section">
          <div class="section-title">Datos Personales</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Nombres <span class="required">*</span></label>
            <input type="text" class="form-input" formControlName="nombres">
          </div>
          <div class="form-group">
            <label>Apellidos <span class="required">*</span></label>
            <input type="text" class="form-input" formControlName="apellidos">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Correo <span class="required">*</span></label>
            <input type="email" class="form-input" formControlName="correo">
          </div>
          <div class="form-group">
            <label>Fecha de Nacimiento <span class="required">*</span></label>
            <input type="date" class="form-input" formControlName="fechaNacimiento">
          </div>
        </div>

        <!-- Roles de Autoridad -->
        <div class="form-section">
          <div class="section-title">Roles de Autoridad</div>
        </div>

        <div class="checkbox-grid">
          <label class="checkbox-item" *ngFor="let rol of rolesAutoridadDisponibles">
            <input
              type="checkbox"
              [checked]="editRolesAutoridad.includes(rol.id)"
              (change)="onEditRoleChange(rol.id, $event)"
            >
            <span>{{ rol.nombre }}</span>
          </label>
        </div>

        <!-- Facultad/Carrera condicionales -->
        <div class="conditional-field" *ngIf="editNeedsFacultad">
          <div class="form-group">
            <label>Facultad <span class="required">*</span></label>
            <select class="form-select" formControlName="idFacultad">
              <option value="">Seleccionar facultad...</option>
              <option *ngFor="let fac of facultades" [value]="fac.id">{{ fac.nombre }}</option>
            </select>
          </div>
        </div>

        <div class="conditional-field" *ngIf="editNeedsCarrera">
          <div class="form-group">
            <label>Carrera <span class="required">*</span></label>
            <select class="form-select" formControlName="idCarrera">
              <option value="">Seleccionar carrera...</option>
              <option *ngFor="let car of carreras" [value]="car.id">{{ car.nombre }}</option>
            </select>
          </div>
        </div>

        <!-- Roles de Usuario -->
        <div class="form-section">
          <div class="section-title">Roles de Usuario</div>
          <div class="section-description">Los roles marcados como "Automático" son asignados por el sistema</div>
        </div>

        <div class="roles-management">
          <div *ngFor="let rol of editRolesUsuario" class="role-management-item" [class.locked]="rol.automatico">
            <div>
              <div class="role-name">{{ rol.nombre }}</div>
              <div class="role-description">{{ rol.descripcion }}</div>
            </div>
            <span class="auto-badge" *ngIf="rol.automatico">Automático</span>
            <input type="checkbox" *ngIf="!rol.automatico" [checked]="rol.activo" (change)="toggleRolUsuario(rol)">
          </div>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" (click)="closeEditModal()">Cancelar</button>
      <button class="btn btn-primary" (click)="updateAutoridad()" [disabled]="editForm.invalid || isUpdating">
        {{ isUpdating ? 'Actualizando...' : 'Actualizar' }}
      </button>
    </div>
  </div>
</div>

<!-- MODAL: VER ROLES -->
<div class="modal-overlay" *ngIf="showRolesModal" (click)="closeRolesModal()">
  <div class="modal-content modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Roles de Usuario - {{ selectedUsuario?.usuarioApp }}</h3>
      <button class="close-btn" (click)="closeRolesModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <div class="alert info">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p>Los roles automáticos no pueden ser removidos. Para modificarlos, debe cambiar los roles de autoridad.</p>
      </div>

      <div class="form-section">
        <div class="section-title">Roles Automáticos</div>
        <div class="section-description">Asignados por el sistema según roles de autoridad</div>
      </div>

      <div class="roles-list">
        <div *ngFor="let rol of rolesAutomaticos" class="role-list-item locked">
          <span class="role-name">{{ rol }}</span>
          <span class="auto-badge">Automático</span>
        </div>
      </div>

      <div class="form-section">
        <div class="section-title">Roles Adicionales</div>
        <div class="section-description">Asignados manualmente</div>
      </div>

      <div class="roles-list" *ngIf="rolesAdicionales.length > 0">
        <div *ngFor="let rol of rolesAdicionales" class="role-list-item">
          <span class="role-name">{{ rol }}</span>
          <button class="btn btn-sm btn-danger" (click)="removeRole(rol)">Remover</button>
        </div>
      </div>
      <div *ngIf="rolesAdicionales.length === 0" class="empty-state-sm">
        No hay roles adicionales asignados
      </div>

      <div class="form-section">
        <div class="section-title">Agregar Rol</div>
      </div>

      <div class="form-group">
        <select class="form-select" [(ngModel)]="newRoleToAdd">
          <option value="">Seleccionar rol...</option>
          <option *ngFor="let rol of availableRolesToAdd" [value]="rol">{{ rol }}</option>
        </select>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" (click)="closeRolesModal()">Cerrar</button>
      <button class="btn btn-primary" (click)="addRole()" [disabled]="!newRoleToAdd">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Agregar Rol
      </button>
    </div>
  </div>
</div>
