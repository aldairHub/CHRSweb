<!-- gestion-usuarios.component.html -->
<app-navbar></app-navbar>

<div class="main-container">
  <div class="content-wrapper">

    <!-- Header -->
    <div class="page-header">
      <div>
        <h2>Gestión de Usuarios</h2>
        <p class="page-subtitle">Autoridades Académicas</p>
      </div>

      <button class="btn btn-primary" (click)="openCreateModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Nueva Autoridad
      </button>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
        </div>
        <div class="stat-content">
          <h3>Total Usuarios</h3>
          <div class="stat-value">{{ totalUsuarios }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon success">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="stat-content">
          <h3>Activos</h3>
          <div class="stat-value">{{ usuariosActivos }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon purple">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
        </div>
        <div class="stat-content">
          <h3>Decanos</h3>
          <div class="stat-value">{{ totalDecanos }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon blue">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
          </svg>
        </div>
        <div class="stat-content">
          <h3>Coordinadores</h3>
          <div class="stat-value">{{ totalCoordinadores }}</div>
        </div>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters-section">
      <div class="search-box">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          type="text"
          class="form-input with-icon"
          placeholder="Buscar por nombre, apellido o correo..."
          [(ngModel)]="searchTerm"
          (input)="applyFilters()"
        >
      </div>

      <select class="form-select" [(ngModel)]="filterRoleId" (change)="applyFilters()">
        <option [ngValue]="null">Todos los Roles</option>
        <option *ngFor="let rol of rolesAutoridadDisponibles" [ngValue]="rol.idRolAutoridad">
          {{ rol.nombre }}
        </option>
      </select>

      <select class="form-select" [(ngModel)]="filterStatus" (change)="applyFilters()">
        <option value="">Todos los Estados</option>
        <option value="true">Activos</option>
        <option value="false">Inactivos</option>
      </select>
    </div>

    <!-- Table -->
    <div class="table-container">
      <table class="table">
        <thead>
        <tr>
          <th>ID</th>
          <th>Nombre Completo</th>
          <th>Correo</th>
          <th>Roles de Autoridad</th>
          <th>Institución</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
        </thead>

        <tbody>
        <tr *ngFor="let usuario of usuariosPaginados">
          <td><strong>#{{ usuario.idAutoridad }}</strong></td>
          <td>{{ usuario.nombres }} {{ usuario.apellidos }}</td>
          <td>{{ usuario.correo }}</td>

          <td>
            <div class="roles-container">
              <span
                *ngFor="let rol of usuario.rolesAutoridad"
                class="role-badge"
                [ngClass]="getRolClass(rol.nombre)"
              >
                {{ rol.nombre }}
              </span>
              <span *ngIf="!usuario.rolesAutoridad?.length" class="text-muted">N/A</span>
            </div>
          </td>

          <td>
            {{ getNombreInstitucion(usuario.idInstitucion) || 'N/A' }}
          </td>

          <td>
            <span class="badge" [ngClass]="usuario.estado ? 'success' : 'danger'">
              <span class="status-dot"></span>
              {{ usuario.estado ? 'Activo' : 'Inactivo' }}
            </span>
          </td>

          <td>
            <div class="action-buttons">
              <label class="toggle-switch" [title]="usuario.estado ? 'Desactivar' : 'Activar'">
                <input type="checkbox" [checked]="usuario.estado" (change)="toggleStatus(usuario)">
                <span class="toggle-slider"></span>
              </label>

              <button class="btn-icon" (click)="openEditModal(usuario)" title="Editar">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>
              </button>

              <button class="btn-icon" (click)="openRolesModal(usuario)" title="Ver Roles">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z" />
                </svg>
              </button>

              <button class="btn-icon" (click)="deleteAutoridad(usuario)" title="Eliminar">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </td>
        </tr>

        <tr *ngIf="usuariosFiltrados.length === 0">
          <td colspan="7" class="empty-state">
            <p>No se encontraron usuarios</p>
          </td>
        </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="totalPages > 1">
      <div class="pagination-info">
        Mostrando {{ (currentPage - 1) * pageSize + 1 }}-{{ Math.min(currentPage * pageSize, usuariosFiltrados.length) }} de {{ usuariosFiltrados.length }}
      </div>

      <div class="pagination-controls">
        <button class="btn btn-sm btn-outline" [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">
          Anterior
        </button>

        <button
          *ngFor="let page of getPageNumbers()"
          class="btn btn-sm"
          [ngClass]="page === currentPage ? 'btn-primary' : 'btn-outline'"
          (click)="page !== -1 && changePage(page)"
          [disabled]="page === -1"
        >
          {{ page === -1 ? '...' : page }}
        </button>

        <button class="btn btn-sm btn-outline" [disabled]="currentPage === totalPages" (click)="changePage(currentPage + 1)">
          Siguiente
        </button>
      </div>
    </div>

  </div>
</div>

<!-- MODAL: CREAR -->
<div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Nueva Autoridad Académica</h3>
      <button class="close-btn" (click)="closeCreateModal()">✕</button>
    </div>

    <div class="modal-body">
      <div class="alert info">
        <div>
          <strong>Información</strong>
          <p>Se generarán credenciales automáticamente y se enviarán al correo.</p>
        </div>
      </div>

      <form [formGroup]="createForm">
        <div class="form-row">
          <div class="form-group">
            <label>Nombres *</label>
            <input type="text" class="form-input" formControlName="nombres">
          </div>
          <div class="form-group">
            <label>Apellidos *</label>
            <input type="text" class="form-input" formControlName="apellidos">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Correo *</label>
            <input type="email" class="form-input" formControlName="correo">
          </div>
          <div class="form-group">
            <label>Fecha Nacimiento *</label>
            <input type="date" class="form-input" formControlName="fechaNacimiento">
          </div>
        </div>

        <div class="form-group">
          <label>Institución *</label>
          <select class="form-select" formControlName="idInstitucion">
            <option [ngValue]="null">Seleccionar...</option>
            <option *ngFor="let inst of instituciones" [ngValue]="inst.idInstitucion">{{ inst.nombre }}</option>
          </select>
        </div>

        <div class="form-section">
          <div class="section-title">Roles de Autoridad *</div>
          <div class="section-description">Seleccione uno o más</div>
        </div>

        <div class="checkbox-grid" formArrayName="rolesAutoridad">
          <label class="checkbox-item" *ngFor="let rol of rolesAutoridadDisponibles; let i = index">
            <input type="checkbox" [formControlName]="i" (change)="onCreateRolesChanged()">
            <span>{{ rol.nombre }}</span>
          </label>
        </div>

        <div class="error-message" *ngIf="rolesAutoridadErrorCreate">
          Debe seleccionar al menos un rol de autoridad
        </div>

        <div class="roles-preview">
          <div *ngIf="previewRoles.length === 0" class="preview-empty">
            Seleccione roles para ver un resumen...
          </div>
          <div *ngFor="let rol of previewRoles" class="role-preview-item">
            <div>
              <div class="role-name">{{ rol.nombre }}</div>
              <div class="role-description">{{ rol.descripcion }}</div>
            </div>
            <span class="auto-badge">Automático</span>
          </div>
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" (click)="closeCreateModal()">Cancelar</button>
      <button class="btn btn-primary" (click)="saveAutoridad()" [disabled]="createForm.invalid || isSaving">
        {{ isSaving ? 'Guardando...' : 'Crear Autoridad' }}
      </button>
    </div>
  </div>
</div>

<!-- MODAL: EDITAR -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Editar Autoridad</h3>
      <button class="close-btn" (click)="closeEditModal()">✕</button>
    </div>

    <div class="modal-body">
      <form [formGroup]="editForm" *ngIf="selectedUsuario">
        <div class="form-row">
          <div class="form-group">
            <label>ID Autoridad</label>
            <input class="form-input" [value]="'#' + selectedUsuario.idAutoridad" disabled>
          </div>
          <div class="form-group">
            <label>ID Usuario</label>
            <input class="form-input" [value]="'#' + selectedUsuario.idUsuario" disabled>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Nombres *</label>
            <input type="text" class="form-input" formControlName="nombres">
          </div>
          <div class="form-group">
            <label>Apellidos *</label>
            <input type="text" class="form-input" formControlName="apellidos">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Correo *</label>
            <input type="email" class="form-input" formControlName="correo">
          </div>
          <div class="form-group">
            <label>Fecha Nacimiento *</label>
            <input type="date" class="form-input" formControlName="fechaNacimiento">
          </div>
        </div>

        <div class="form-group">
          <label>Institución *</label>
          <select class="form-select" formControlName="idInstitucion">
            <option [ngValue]="null">Seleccionar...</option>
            <option *ngFor="let inst of instituciones" [ngValue]="inst.idInstitucion">{{ inst.nombre }}</option>
          </select>
        </div>

        <div class="form-group">
          <label>Estado</label>
          <select class="form-select" formControlName="estado">
            <option [ngValue]="true">Activo</option>
            <option [ngValue]="false">Inactivo</option>
          </select>
        </div>

        <div class="form-section">
          <div class="section-title">Roles de Autoridad *</div>
        </div>

        <div class="checkbox-grid" formArrayName="rolesAutoridad">
          <label class="checkbox-item" *ngFor="let rol of rolesAutoridadDisponibles; let i = index">
            <input type="checkbox" [formControlName]="i" (change)="onEditRolesChanged()">
            <span>{{ rol.nombre }}</span>
          </label>
        </div>

        <div class="error-message" *ngIf="rolesAutoridadErrorEdit">
          Debe seleccionar al menos un rol de autoridad
        </div>
      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" (click)="closeEditModal()">Cancelar</button>
      <button class="btn btn-primary" (click)="updateAutoridad()" [disabled]="editForm.invalid || isUpdating">
        {{ isUpdating ? 'Actualizando...' : 'Actualizar' }}
      </button>
    </div>
  </div>
</div>

<!-- MODAL: VER ROLES -->
<div class="modal-overlay" *ngIf="showRolesModal" (click)="closeRolesModal()">
  <div class="modal-content modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Roles de Autoridad</h3>
      <button class="close-btn" (click)="closeRolesModal()">✕</button>
    </div>

    <div class="modal-body" *ngIf="selectedUsuario">
      <div class="roles-list">
        <div *ngFor="let rol of selectedUsuario.rolesAutoridad" class="role-list-item">
          <span class="role-name">{{ rol.nombre }}</span>
        </div>

        <div *ngIf="!selectedUsuario.rolesAutoridad?.length" class="empty-state-sm">
          No hay roles asignados
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" (click)="closeRolesModal()">Cerrar</button>
    </div>
  </div>
</div>
