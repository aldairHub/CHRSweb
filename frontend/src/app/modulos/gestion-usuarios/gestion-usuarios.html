<!-- gestion-usuarios.component.html -->
<app-navbar></app-navbar>

<div class="main-container">
  <div class="content-wrapper">

    <!-- Header de la página -->
    <div class="page-header">
      <div>
        <h2>Gestión de Usuarios</h2>
        <p class="page-subtitle">Autoridades Académicas</p>
      </div>
      <button class="btn btn-primary" (click)="openCreateModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Nueva Autoridad
      </button>
    </div>

    <!-- Tarjetas de Estadísticas -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
          </svg>
        </div>
        <div class="stat-content">
          <h3>Total Usuarios</h3>
          <div class="stat-value">{{ totalUsuarios }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon success">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="stat-content">
          <h3>Activos</h3>
          <div class="stat-value">{{ usuariosActivos }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon purple">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
          </svg>
        </div>
        <div class="stat-content">
          <h3>Decanos</h3>
          <div class="stat-value">{{ totalDecanos }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon blue">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
          </svg>
        </div>
        <div class="stat-content">
          <h3>Coordinadores</h3>
          <div class="stat-value">{{ totalCoordinadores }}</div>
        </div>
      </div>
    </div>

    <!-- Filtros y Búsqueda -->
    <div class="filters-section">
      <div class="search-box">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          type="text"
          class="form-input with-icon"
          placeholder="Buscar por nombre, apellido o correo..."
          [(ngModel)]="searchTerm"
          (input)="applyFilters()"
        >
      </div>

      <select class="form-select" [(ngModel)]="filterRole" (change)="applyFilters()">
        <option value="">Todos los Roles</option>
        <option *ngFor="let r of rolesAutoridadDisponibles" [value]="r.idRolAutoridad">
          {{ r.nombre }}
        </option>
      </select>

      <select class="form-select" [(ngModel)]="filterStatus" (change)="applyFilters()">
        <option value="">Todos los Estados</option>
        <option value="true">Activos</option>
        <option value="false">Inactivos</option>
      </select>
    </div>

    <!-- Tabla de Usuarios -->
    <div class="table-container">
      <table class="table">
        <thead>
        <tr>
          <th>ID Autoridad</th>
          <th>Nombre Completo</th>
          <th>Correo</th>
          <th>Roles de Autoridad</th>
          <th>Institución</th>
          <th>Estado</th>
          <th>Acciones</th>
        </tr>
        </thead>
        <tbody>

        <tr *ngFor="let usuario of usuariosPaginados">
          <td><strong>#{{ usuario.idAutoridad }}</strong></td>
          <td>{{ usuario.nombres }} {{ usuario.apellidos }}</td>
          <td>{{ usuario.correo }}</td>

          <td>
            <div class="roles-container">
              <span
                *ngFor="let rol of usuario.rolesAutoridad"
                class="role-badge"
                [ngClass]="getRolClass(rol.nombre)"
                title="ID rol: {{ rol.idRolAutoridad }}"
              >
                {{ getRolLabel(rol.nombre) }}
              </span>
            </div>
          </td>

          <td>
            <span *ngIf="getInstitucionNombre(usuario.idInstitucion); else instNA">
              {{ getInstitucionNombre(usuario.idInstitucion) }}
            </span>
            <ng-template #instNA>
              <span class="text-muted">N/A</span>
            </ng-template>
          </td>

          <td>
            <span class="badge" [ngClass]="usuario.estado ? 'success' : 'danger'">
              <span class="status-dot"></span>
              {{ usuario.estado ? 'Activo' : 'Inactivo' }}
            </span>
          </td>

          <td>
            <div class="action-buttons">
              <!-- Por ahora el toggle es UI (si aún no tienes endpoint de activar/desactivar autoridad/usuario) -->
              <label class="toggle-switch" [title]="usuario.estado ? 'Desactivar' : 'Activar'">
                <input type="checkbox" [checked]="usuario.estado" (change)="toggleStatus(usuario)">
                <span class="toggle-slider"></span>
              </label>

              <button class="btn-icon" (click)="openEditModal(usuario)" title="Editar">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
              </button>

              <button class="btn-icon" (click)="openRolesModal(usuario)" title="Ver Roles">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>

        <tr *ngIf="usuariosFiltrados.length === 0">
          <td colspan="7" class="empty-state">
            <div class="empty-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
              </svg>
            </div>
            <p>No se encontraron usuarios</p>
            <small>Intenta ajustar los filtros de búsqueda</small>
          </td>
        </tr>

        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="pagination" *ngIf="totalPages > 1">
      <div class="pagination-info">
        Mostrando {{ (currentPage - 1) * pageSize + 1 }}-{{ Math.min(currentPage * pageSize, usuariosFiltrados.length) }} de {{ usuariosFiltrados.length }}
      </div>
      <div class="pagination-controls">
        <button class="btn btn-sm btn-outline" [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">
          Anterior
        </button>

        <button
          *ngFor="let page of getPageNumbers()"
          class="btn btn-sm"
          [ngClass]="page === currentPage ? 'btn-primary' : 'btn-outline'"
          (click)="page > 0 && changePage(page)"
          [disabled]="page === -1"
        >
          {{ page === -1 ? '…' : page }}
        </button>

        <button class="btn btn-sm btn-outline" [disabled]="currentPage === totalPages" (click)="changePage(currentPage + 1)">
          Siguiente
        </button>
      </div>
    </div>

  </div>
</div>

<!-- MODAL: CREAR AUTORIDAD -->
<div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Nueva Autoridad Académica</h3>
      <button class="close-btn" (click)="closeCreateModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="modal-body">

      <div class="alert info">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <div>
          <strong>Información Importante</strong>
          <p>El sistema generará automáticamente las credenciales y enviará un correo electrónico al usuario con sus datos de acceso.</p>
        </div>
      </div>

      <form [formGroup]="createForm">

        <div class="form-section">
          <div class="section-title">Datos Personales</div>
          <div class="section-description">Información básica de la autoridad académica</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Nombres <span class="required">*</span></label>
            <input type="text" class="form-input" formControlName="nombres" placeholder="Ej: Juan Carlos">
            <div class="error-message" *ngIf="createForm.get('nombres')?.invalid && createForm.get('nombres')?.touched">
              Este campo es obligatorio
            </div>
          </div>

          <div class="form-group">
            <label>Apellidos <span class="required">*</span></label>
            <input type="text" class="form-input" formControlName="apellidos" placeholder="Ej: Pérez Morales">
            <div class="error-message" *ngIf="createForm.get('apellidos')?.invalid && createForm.get('apellidos')?.touched">
              Este campo es obligatorio
            </div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Correo Electrónico <span class="required">*</span></label>
            <input type="email" class="form-input" formControlName="correo" placeholder="usuario@uteq.edu.ec">
            <small class="help-text">Se enviará las credenciales a este correo</small>
            <div class="error-message" *ngIf="createForm.get('correo')?.invalid && createForm.get('correo')?.touched">
              Ingrese un correo válido
            </div>
          </div>

          <div class="form-group">
            <label>Fecha de Nacimiento <span class="required">*</span></label>
            <input type="date" class="form-input" formControlName="fechaNacimiento">
          </div>
        </div>

        <div class="form-group">
          <label>Institución <span class="required">*</span></label>
          <select class="form-select" formControlName="idInstitucion">
            <option [ngValue]="null">Seleccionar institución...</option>
            <option *ngFor="let inst of instituciones" [ngValue]="inst.idInstitucion">
              {{ inst.nombreInstitucion }}
            </option>
          </select>
        </div>

        <div class="form-section">
          <div class="section-title">Roles de Autoridad</div>
          <div class="section-description">Seleccione uno o más roles</div>
        </div>

        <div class="checkbox-grid">
          <label class="checkbox-item" *ngFor="let rol of rolesAutoridadDisponibles">
            <input
              type="checkbox"
              [checked]="selectedRolIds.includes(rol.idRolAutoridad)"
              (change)="onRoleToggle(rol.idRolAutoridad, $event)"
            >
            <span>{{ rol.nombre }}</span>
          </label>
        </div>

        <div class="roles-preview">
          <div *ngIf="selectedRolIds.length === 0" class="preview-empty">
            Seleccione roles de autoridad...
          </div>

          <div *ngIf="selectedRolIds.length > 0">
            <div class="section-description" style="margin: 6px 0 10px;">
              Roles de usuario asignados automáticamente
            </div>

            <div *ngIf="loadingRolesUsuario" class="preview-empty">
              Cargando roles de usuario...
            </div>

            <div *ngIf="!loadingRolesUsuario && rolesUsuarioPreview.length === 0" class="preview-empty">
              No hay roles de usuario asociados.
            </div>

            <div class="roles-container" *ngIf="!loadingRolesUsuario && rolesUsuarioPreview.length > 0">
      <span class="role-badge" *ngFor="let ru of rolesUsuarioPreview">
        {{ ru.nombre }}
      </span>
            </div>
          </div>
        </div>

      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" (click)="closeCreateModal()">Cancelar</button>
      <button class="btn btn-primary" (click)="saveAutoridad()" [disabled]="createForm.invalid || isSaving || selectedRolIds.length === 0">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        {{ isSaving ? 'Guardando...' : 'Crear Autoridad' }}
      </button>
    </div>
  </div>
</div>

<!-- MODAL EDITAR / ROLES: se mantiene tu estructura, pero por ahora queda como UI si no tienes endpoints -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Editar Autoridad Académica</h3>
      <button class="close-btn" (click)="closeEditModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <div class="alert info">
        <p>Por definir.</p>
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" (click)="closeEditModal()">Cerrar</button>
    </div>
  </div>
</div>

<div class="modal-overlay" *ngIf="showRolesModal" (click)="closeRolesModal()">
  <div class="modal-content modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Roles - #{{ selectedUsuario?.idAutoridad }}</h3>
      <button class="close-btn" (click)="closeRolesModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <div class="roles-list">
        <div *ngFor="let r of selectedUsuario?.rolesAutoridad" class="role-list-item locked">
          <span class="role-name">{{ r.nombre }}</span>
          <span class="auto-badge">Autoridad</span>
        </div>
      </div>
      <div *ngIf="!selectedUsuario?.rolesAutoridad?.length" class="empty-state-sm">
        Sin roles
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" (click)="closeRolesModal()">Cerrar</button>
    </div>
  </div>
</div>
