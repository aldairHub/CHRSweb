<app-navbar></app-navbar>

<div class="main-container">
  <div class="content-wrapper">

    <!-- Header -->
    <div class="page-header">
      <div>
        <h2>Auditoría de accesos</h2>
        <p class="page-subtitle">Registro de todos los intentos de inicio de sesión al sistema</p>
      </div>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div class="stat-content">
          <h3>Total hoy</h3>
          <div class="stat-value">{{ totalHoy }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon success">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div class="stat-content">
          <h3>Exitosos hoy</h3>
          <div class="stat-value">{{ exitososHoy }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon danger">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <div class="stat-content">
          <h3>Fallidos hoy</h3>
          <div class="stat-value">{{ fallidosHoy }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon blue">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 6h16M4 10h16M4 14h16M4 18h16"/>
          </svg>
        </div>
        <div class="stat-content">
          <h3>Total registros</h3>
          <div class="stat-value">{{ totalElements }}</div>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters-card">
      <div class="filters-grid">
        <div class="filter-group">
          <label>Usuario</label>
          <div class="input-wrapper">
            <svg class="input-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
            <input type="text" class="form-input" placeholder="Buscar usuario..."
                   [(ngModel)]="filtroUsuario" (keyup.enter)="aplicarFiltros()"/>
          </div>
        </div>

        <div class="filter-group">
          <label>Resultado</label>
          <select class="form-select" [(ngModel)]="filtroResultado" (change)="aplicarFiltros()">
            <option value="">Todos</option>
            <option value="SUCCESS">Exitoso</option>
            <option value="FAIL">Fallido</option>
          </select>
        </div>

        <div class="filter-group">
          <label>Desde</label>
          <input type="date" class="form-input" [(ngModel)]="filtroDesde" (change)="aplicarFiltros()"/>
        </div>

        <div class="filter-group">
          <label>Hasta</label>
          <input type="date" class="form-input" [(ngModel)]="filtroHasta" (change)="aplicarFiltros()"/>
        </div>
      </div>

      <div class="filters-actions">
        <button class="btn btn-primary" (click)="aplicarFiltros()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
          Buscar
        </button>
        <button class="btn btn-outline" (click)="limpiarFiltros()">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="18" height="18">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
          Limpiar
        </button>
      </div>
    </div>

    <!-- Tabla -->
    <div class="table-card">
      <div class="table-header">
        <span class="table-count">{{ totalElements }} registros encontrados</span>
      </div>

      <div class="table-wrapper">
        <div *ngIf="isLoading" class="loading-state">
          <svg class="spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 1 1-6.219-8.56"/>
          </svg>
          <span>Cargando registros...</span>
        </div>

        <table *ngIf="!isLoading">
          <thead>
          <tr>
            <th>#</th>
            <th>Fecha y hora</th>
            <th>Usuario</th>
            <th>Usuario BD</th>
            <th>Resultado</th>
            <th>Motivo</th>
            <th>IP</th>
            <th></th>
          </tr>
          </thead>
          <tbody>
          <tr *ngFor="let r of registros" [class.row-fail]="r.resultado === 'FAIL'">
            <td class="col-id">{{ r.idAud }}</td>
            <td class="col-fecha">{{ formatFecha(r.fecha) }}</td>
            <td class="col-usuario">{{ r.usuarioApp }}</td>
            <td class="col-usuariobd">{{ r.usuarioBd ?? '—' }}</td>
            <td class="col-resultado">
                <span class="badge" [class.badge-success]="r.resultado === 'SUCCESS'"
                      [class.badge-fail]="r.resultado === 'FAIL'">
                  {{ r.resultado === 'SUCCESS' ? 'Exitoso' : 'Fallido' }}
                </span>
            </td>
            <td class="col-motivo">{{ formatMotivo(r.motivo) }}</td>
            <td class="col-ip">{{ r.ipCliente ?? '—' }}</td>
            <td class="col-actions">
              <button class="btn-icon" title="Ver detalle" (click)="verDetalle(r)">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                </svg>
              </button>
            </td>
          </tr>

          <tr *ngIf="registros.length === 0">
            <td colspan="8" class="empty-state">
              <div class="empty-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                </svg>
              </div>
              <p>No hay registros con los filtros aplicados</p>
              <small>Intenta ajustar los criterios de búsqueda</small>
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- Paginación -->
      <div class="pagination" *ngIf="totalPages > 1">
        <button class="page-btn" (click)="irPagina(0)" [disabled]="currentPage === 0">«</button>
        <button class="page-btn" (click)="irPagina(currentPage - 1)" [disabled]="currentPage === 0">‹</button>
        <button class="page-btn" *ngFor="let p of pages"
                [class.active]="p === currentPage" (click)="irPagina(p)">
          {{ p + 1 }}
        </button>
        <button class="page-btn" (click)="irPagina(currentPage + 1)" [disabled]="currentPage === totalPages - 1">›</button>
        <button class="page-btn" (click)="irPagina(totalPages - 1)"  [disabled]="currentPage === totalPages - 1">»</button>
        <span class="page-info">Página {{ currentPage + 1 }} de {{ totalPages }}</span>
      </div>
    </div>

  </div>
</div>

<!-- Modal detalle -->
<div class="modal-overlay" *ngIf="registroDetalle" (click)="cerrarDetalle()">
  <div class="modal-box" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Detalle del registro</h3>
      <button class="modal-close" (click)="cerrarDetalle()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="detail-row">
        <span class="detail-label">ID</span>
        <span class="detail-value">{{ registroDetalle!.idAud }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Fecha y hora</span>
        <span class="detail-value">{{ formatFecha(registroDetalle!.fecha) }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Usuario app</span>
        <span class="detail-value">{{ registroDetalle!.usuarioApp }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Usuario BD</span>
        <span class="detail-value">{{ registroDetalle!.usuarioBd ?? '—' }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Resultado</span>
        <span class="badge" [class.badge-success]="registroDetalle!.resultado === 'SUCCESS'"
              [class.badge-fail]="registroDetalle!.resultado === 'FAIL'">
          {{ registroDetalle!.resultado === 'SUCCESS' ? 'Exitoso' : 'Fallido' }}
        </span>
      </div>
      <div class="detail-row">
        <span class="detail-label">Motivo</span>
        <span class="detail-value">{{ formatMotivo(registroDetalle!.motivo) }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">IP cliente</span>
        <span class="detail-value">{{ registroDetalle!.ipCliente ?? '—' }}</span>
      </div>
      <div class="detail-row">
        <span class="detail-label">User agent</span>
        <span class="detail-value detail-ua">{{ registroDetalle!.userAgent ?? '—' }}</span>
      </div>
    </div>
  </div>
</div>
