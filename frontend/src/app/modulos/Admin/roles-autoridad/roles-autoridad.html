<app-navbar></app-navbar>

<div class="main-container">
  <div class="content-wrapper">

    <div class="page-header">
      <div>
        <h2>Gestión de Roles Académicos</h2>
        <p class="page-subtitle">Rol Autoridad ↔ Rol Usuario</p>
      </div>

      <button class="btn btn-primary" (click)="openCreateModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Nuevo Rol Autoridad
      </button>
    </div>

    <!-- Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-icon">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 11c0 1.657-1.79 3-4 3S4 12.657 4 11s1.79-3 4-3 4 1.343 4 3zm8 0c0 1.657-1.79 3-4 3s-4-1.343-4-3 1.79-3 4-3 4 1.343 4 3z"/>
          </svg>
        </div>
        <div class="stat-content">
          <h3>Total Roles Autoridad</h3>
          <div class="stat-value">{{ totalRolesAutoridad }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon purple">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857"/>
          </svg>
        </div>
        <div class="stat-content">
          <h3>Asignaciones</h3>
          <div class="stat-value">{{ totalAsignaciones }}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon blue">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M18 9v3m0 0v3m0-3h3m-3 0h-3M9 12h.01M9 16h.01M9 8h.01M5 20h14a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
          </svg>
        </div>
        <div class="stat-content">
          <h3>Sin Roles</h3>
          <div class="stat-value">{{ totalSinRoles }}</div>
        </div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="filters-section">
      <div class="search-box">
        <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          type="text"
          class="form-input with-icon"
          placeholder="Buscar por nombre o ID..."
          [(ngModel)]="searchTerm"
          (input)="applyFilters()"
        >
      </div>

      <select class="form-select" [(ngModel)]="filterHasRoles" (change)="applyFilters()">
        <option value="">Todos</option>
        <option value="con">Con roles usuario</option>
        <option value="sin">Sin roles usuario</option>
      </select>
    </div>

    <!-- Tabla -->
    <div class="table-container">
      <table class="table">
        <thead>
        <tr>
          <th>ID</th>
          <th>Rol Autoridad</th>
          <th>Roles Usuario Asociados</th>
          <th>Acciones</th>
        </tr>
        </thead>
        <tbody>

        <tr *ngFor="let r of rolesPaginados">
          <td><strong>#{{ r.idRolAutoridad }}</strong></td>
          <td>{{ r.nombre }}</td>

          <td>
            <div class="roles-container" *ngIf="(r.rolesUsuario || []).length > 0; else noRoles">
              <span class="role-badge neutral" *ngFor="let ru of r.rolesUsuario">
                {{ ru.nombre }}
              </span>
            </div>
            <ng-template #noRoles>
              <span class="text-muted">Sin asignación</span>
            </ng-template>
          </td>

          <td>
            <div class="action-buttons">
              <button class="btn-icon" (click)="openEditModal(r)" title="Editar">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                </svg>
              </button>

              <button class="btn-icon" (click)="openRolesModal(r)" title="Ver Roles">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M16 7a4 4 0 010 8m-8 0a4 4 0 110-8m0 0V5a2 2 0 012-2h4a2 2 0 012 2v2"/>
                </svg>
              </button>
            </div>
          </td>
        </tr>

        <tr *ngIf="rolesFiltrados.length === 0">
          <td colspan="4" class="empty-state">
            <div class="empty-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5"/>
              </svg>
            </div>
            <p>No se encontraron roles</p>
            <small>Prueba cambiar los filtros</small>
          </td>
        </tr>

        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    <div class="pagination" *ngIf="totalPages > 1">
      <div class="pagination-info">
        Mostrando {{ (currentPage - 1) * pageSize + 1 }}-{{ Math.min(currentPage * pageSize, rolesFiltrados.length) }}
        de {{ rolesFiltrados.length }}
      </div>
      <div class="pagination-controls">
        <button class="btn btn-sm btn-outline" [disabled]="currentPage === 1" (click)="changePage(currentPage - 1)">
          Anterior
        </button>

        <button
          *ngFor="let page of getPageNumbers()"
          class="btn btn-sm"
          [ngClass]="page === currentPage ? 'btn-primary' : 'btn-outline'"
          (click)="page > 0 && changePage(page)"
          [disabled]="page === -1"
        >
          {{ page === -1 ? '…' : page }}
        </button>

        <button class="btn btn-sm btn-outline" [disabled]="currentPage === totalPages" (click)="changePage(currentPage + 1)">
          Siguiente
        </button>
      </div>
    </div>

  </div>
</div>

<!-- MODAL CREAR -->
<div class="modal-overlay" *ngIf="showCreateModal" (click)="closeCreateModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Nuevo Rol de Autoridad</h3>
      <button class="close-btn" (click)="closeCreateModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <form [formGroup]="form">

        <div class="form-section">
          <div class="section-title">Datos del Rol</div>
          <div class="section-description">Nombre del rol de autoridad</div>
        </div>

        <div class="form-group">
          <label>Nombre <span class="required">*</span></label>
          <input type="text" class="form-input" formControlName="nombre" placeholder="Ej: DECANATO DE LA FACULTAD">
          <div class="error-message" *ngIf="form.get('nombre')?.invalid && form.get('nombre')?.touched">
            Este campo es obligatorio (mínimo 3 caracteres)
          </div>
        </div>

        <div class="form-section">
          <div class="section-title">Roles de Usuario</div>
          <div class="section-description">Asigna uno o más roles de usuario</div>
        </div>

        <div class="checkbox-grid">
          <label class="checkbox-item" *ngFor="let ru of rolesUsuarioDisponibles">
            <input
              type="checkbox"
              [checked]="selectedRolesUsuarioIds.includes(ru.idRolUsuario)"
              (change)="onRolUsuarioToggle(ru.idRolUsuario, $event)"
            >
            <span>{{ ru.nombre }}</span>
          </label>
        </div>

      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" (click)="closeCreateModal()">Cancelar</button>
      <button class="btn btn-primary" (click)="save()" [disabled]="form.invalid || isSaving">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        {{ isSaving ? 'Guardando...' : 'Crear Rol' }}
      </button>
    </div>
  </div>
</div>

<!-- MODAL EDITAR -->
<div class="modal-overlay" *ngIf="showEditModal" (click)="closeEditModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Editar Rol de Autoridad</h3>
      <button class="close-btn" (click)="closeEditModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <form [formGroup]="form">

        <div class="form-section">
          <div class="section-title">Datos del Rol</div>
          <div class="section-description">Actualiza nombre y relaciones</div>
        </div>

        <div class="form-group">
          <label>Nombre <span class="required">*</span></label>
          <input type="text" class="form-input" formControlName="nombre">
        </div>

        <div class="form-section">
          <div class="section-title">Roles de Usuario</div>
          <div class="section-description">Selecciona los roles a asociar</div>
        </div>

        <div class="checkbox-grid">
          <label class="checkbox-item" *ngFor="let ru of rolesUsuarioDisponibles">
            <input
              type="checkbox"
              [checked]="selectedRolesUsuarioIds.includes(ru.idRolUsuario)"
              (change)="onRolUsuarioToggle(ru.idRolUsuario, $event)"
            >
            <span>{{ ru.nombre }}</span>
          </label>
        </div>

      </form>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" (click)="closeEditModal()">Cancelar</button>
      <button class="btn btn-primary" (click)="save()" [disabled]="form.invalid || isSaving">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        {{ isSaving ? 'Guardando...' : 'Guardar Cambios' }}
      </button>
    </div>
  </div>
</div>

<!-- MODAL VER ROLES -->
<div class="modal-overlay" *ngIf="showRolesModal" (click)="closeRolesModal()">
  <div class="modal-content modal-sm" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Roles Usuario - #{{ selectedRolAutoridad?.idRolAutoridad }}</h3>
      <button class="close-btn" (click)="closeRolesModal()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>

    <div class="modal-body">
      <div class="roles-list">
        <div *ngFor="let ru of selectedRolAutoridad?.rolesUsuario" class="role-list-item locked">
          <span class="role-name">{{ ru.nombre }}</span>
          <span class="auto-badge">Usuario</span>
        </div>
      </div>

      <div *ngIf="!(selectedRolAutoridad?.rolesUsuario?.length)" class="empty-state-sm">
        Sin roles asociados
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-outline" (click)="closeRolesModal()">Cerrar</button>
    </div>
  </div>
</div>
