<!-- entrevistas-docentes/evaluacion/evaluacion.component.html -->
<app-navbar></app-navbar>

<div class="main-container">
  <div class="content-wrapper">

    <!-- LOADING -->
    <div class="loading-state" *ngIf="isLoading">
      <svg class="spinner-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="32" height="32">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
      </svg>
      <p>Cargando informaci√≥n de la reuni√≥n...</p>
    </div>

    <!-- ERROR -->
    <div class="alert danger" *ngIf="error">
      <div><strong>Error</strong><p>{{ error }}</p></div>
    </div>

    <!-- √âXITO -->
    <div class="alert success" *ngIf="isConfirmado">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      <div>
        <strong>‚úÖ Evaluaci√≥n confirmada y enviada.</strong>
        <p>Redirigiendo al expediente del postulante...</p>
      </div>
    </div>

    <ng-container *ngIf="!isLoading && !error && !isConfirmado && reunion">

      <div class="page-header">
        <div>
          <h2>Evaluaci√≥n: Reuni√≥n #{{ reunion.idReunion }}</h2>
          <p class="page-subtitle">{{ reunion.fecha }} {{ reunion.hora }} | {{ reunion.modalidad }}</p>
        </div>
        <span class="badge warning">En Curso</span>
      </div>

      <!-- INFORMACI√ìN DE LA REUNI√ìN -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Informaci√≥n de la Reuni√≥n</h3>
          <div class="header-actions">
            <button class="btn btn-primary btn-sm" *ngIf="reunion.enlace"
                    (click)="(null); $any(window).open(reunion.enlace, '_blank')">
              üé• Unirse a {{ reunion.modalidad }}
            </button>
          </div>
        </div>
        <div class="info-grid">
          <div>
            <p><strong>Fecha y Hora:</strong> {{ reunion.fecha }} {{ reunion.hora }}</p>
            <p><strong>Duraci√≥n:</strong> {{ reunion.duracionMinutos }} minutos</p>
            <p><strong>Modalidad:</strong> {{ reunion.modalidad }}</p>
          </div>
          <div>
            <p><strong>Evaluadores:</strong></p>
            <ul class="evaluadores-ul">
              <li *ngFor="let ev of reunion.evaluadores">{{ ev }}</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- DECLARACI√ìN DE CONFLICTO -->
      <div class="conflict-box">
        <h4>‚ö†Ô∏è Declaraci√≥n de Conflicto de Inter√©s</h4>
        <label class="checkbox-label">
          <input type="checkbox" [(ngModel)]="declaroSinConflicto">
          <span>Declaro que <strong>NO tengo conflictos de inter√©s</strong> con el/la postulante
            que puedan afectar la objetividad de mi evaluaci√≥n.</span>
        </label>
      </div>

      <!-- CRITERIOS DE EVALUACI√ìN -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Criterios de Evaluaci√≥n</h3>
          <span class="badge" [ngClass]="criteriosCompletos ? 'success' : 'warning'">
            {{ criteriosCompletos ? 'Todos calificados' : 'Pendientes de calificar' }}
          </span>
        </div>

        <div class="criterios-list">
          <div class="criterio-eval-item" *ngFor="let c of criterios">
            <div class="criterio-eval-info">
              <div class="criterio-nombre">{{ c.nombre }}</div>
              <small>{{ c.descripcion }}</small>
            </div>
            <div class="criterio-eval-peso"><strong>{{ c.peso }}%</strong></div>

            <!-- ESTRELLAS -->
            <div class="rating-stars">
              <span class="star" *ngFor="let s of getEstrellas(5)"
                    [class.active]="s <= c.estrellas"
                    (click)="setEstrella(c, s)">‚òÖ</span>
            </div>

            <!-- NOTA NUM√âRICA -->
            <div class="criterio-eval-nota">
              <input class="form-input nota-input" type="number"
                     [(ngModel)]="c.nota" min="0" max="5" step="0.1"
                     placeholder="0.0"
                     (ngModelChange)="c.estrellas = Math.round(c.nota)">
            </div>

            <!-- OBSERVACI√ìN POR CRITERIO -->
            <div style="width: 100%; margin-top: 4px;">
              <input class="form-input" type="text" [(ngModel)]="c.observacion"
                     placeholder="Observaci√≥n (opcional)..." style="font-size: 12px;">
            </div>
          </div>
        </div>

        <!-- OBSERVACIONES GENERALES -->
        <div class="form-group mt-2">
          <label>Observaciones Generales <span class="required">*</span></label>
          <textarea class="form-textarea" [(ngModel)]="observaciones"
                    placeholder="Detalle fortalezas, debilidades y recomendaciones del postulante..."></textarea>
          <p class="field-hint">Las observaciones son obligatorias para justificar la evaluaci√≥n.</p>
        </div>

        <!-- CALIFICACI√ìN FINAL -->
        <div class="calificacion-final" *ngIf="criteriosCompletos">
          <div class="calificacion-header">Calificaci√≥n Final de esta Fase</div>
          <div class="calificacion-valor">{{ calificacionFinalSobre5.toFixed(2) }} / 5.0</div>
          <div class="calificacion-pct">
            Equivalente al {{ calificacionFinal.toFixed(1) }}% del peso total de la fase
          </div>
        </div>

        <div class="alert warning" *ngIf="!criteriosCompletos">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <div>
            <strong>Atenci√≥n</strong>
            <p>Debe calificar todos los criterios para ver la calificaci√≥n final.</p>
          </div>
        </div>
      </div>

      <!-- FIRMA DIGITAL -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Confirmaci√≥n de Evaluaci√≥n (Firma Digital)</h3>
        </div>

        <div class="alert warning">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
          </svg>
          <div>
            <strong>Importante</strong>
            <p>Al confirmar, usted certifica que la evaluaci√≥n fue realizada de manera objetiva y profesional.</p>
          </div>
        </div>

        <div class="form-group">
          <label>Firma Digital</label>
          <div class="canvas-wrapper">
            <canvas #canvas class="signature-canvas" width="700" height="180"></canvas>
          </div>
          <button class="btn btn-outline btn-sm mt-1" (click)="limpiarFirma()">
            üóëÔ∏è Limpiar Firma
          </button>
        </div>

        <label class="checkbox-label mt-2">
          <input type="checkbox" [(ngModel)]="confirmado">
          <span>Confirmo que he revisado cuidadosamente todos los criterios y que la evaluaci√≥n refleja mi juicio profesional.</span>
        </label>
      </div>

      <!-- ACCIONES -->
      <div class="footer-actions">
        <button class="btn btn-outline" (click)="guardarBorrador()">Guardar Borrador</button>
        <button class="btn btn-primary" (click)="confirmarEvaluacion()"
                [disabled]="isSaving || !puedeConfirmar">
          <svg *ngIf="isSaving" class="spinner-icon" fill="none" stroke="currentColor"
               viewBox="0 0 24 24" width="18" height="18">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
          </svg>
          {{ isSaving ? 'Confirmando...' : '‚úì Confirmar Evaluaci√≥n' }}
        </button>
      </div>

    </ng-container>
  </div>
</div>
