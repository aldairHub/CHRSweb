<!-- entrevistas-docentes/resultados/resultados.component.html -->
<app-navbar></app-navbar>

<div class="main-container">
  <div class="content-wrapper">

    <div class="page-header">
      <div>
        <h2>Resultados del Proceso</h2>
        <p class="page-subtitle">Consolidado de evaluaciones por postulante</p>
      </div>
      <button class="btn btn-outline" (click)="generarPDF()" [disabled]="!resultado">
        üìÑ Generar Reporte PDF
      </button>
    </div>

    <div class="loading-state" *ngIf="isLoading">
      <svg class="spinner-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="32" height="32">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
      </svg>
      <p>Cargando postulantes...</p>
    </div>

    <div class="alert danger" *ngIf="error">
      <div><strong>Error</strong><p>{{ error }}</p></div>
    </div>

    <ng-container *ngIf="!isLoading && !error">

      <!-- SELECTOR DE POSTULANTE -->
      <div class="card">
        <div class="form-group" style="margin-bottom: 0;">
          <label>Seleccionar Postulante</label>
          <select class="form-select" style="max-width: 480px;"
                  [(ngModel)]="idProcesoSeleccionado" (change)="onProcesoChange()">
            <option [value]="0">Seleccionar...</option>
            <option *ngFor="let p of postulantes" [value]="p.idProceso">
              {{ getNombrePostulante(p) }}
            </option>
          </select>
        </div>
      </div>

      <!-- LOADING RESULTADOS -->
      <div class="loading-state" *ngIf="isLoadingResultado">
        <svg class="spinner-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" width="24" height="24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
        <p>Cargando resultados...</p>
      </div>

      <ng-container *ngIf="!isLoadingResultado && resultado">

        <!-- RESULTADOS POR FASE -->
        <div class="card">
          <div class="card-header">
            <h3 class="card-title">Resultados por Fase</h3>
            <span class="badge" [ngClass]="procesoCompleto ? 'success' : 'warning'">
              {{ procesoCompleto ? 'Proceso Completo' : 'Proceso Incompleto ‚Äì ' + progreso + '%' }}
            </span>
          </div>

          <div class="table-container">
            <table class="table">
              <thead>
              <tr>
                <th>Fase</th><th>Peso</th><th>Calificaci√≥n</th><th>Ponderado</th>
                <th>Evaluadores</th><th>Estado</th><th>Acciones</th>
              </tr>
              </thead>
              <tbody>
              <ng-container *ngFor="let f of fasesResultados">
                <tr>
                  <td><strong>{{ f.nombreFase }}</strong></td>
                  <td>{{ f.peso }}%</td>
                  <td>
                      <span *ngIf="f.calificacion">
                        {{ f.calificacion | number:'1.1-1' }}/5.0
                        ({{ (f.calificacion / 5 * 100).toFixed(0) }}%)
                      </span>
                    <span *ngIf="!f.calificacion" class="text-muted">Pendiente</span>
                  </td>
                  <td>
                    <strong *ngIf="f.ponderado" style="color: var(--primary, #00A63E);">
                      {{ f.ponderado | number:'1.1-1' }}%
                    </strong>
                    <span *ngIf="!f.ponderado" class="text-muted">‚Äî</span>
                  </td>
                  <td>
                    <div class="roles-container">
                      <span class="badge-rol-app" *ngFor="let ev of f.evaluadores">{{ ev }}</span>
                      <span class="text-muted" *ngIf="!f.evaluadores.length">‚Äî</span>
                    </div>
                  </td>
                  <td>
                      <span class="badge" [ngClass]="getBadgeClass(f.estado)">
                        {{ getBadgeLabel(f.estado) }}
                      </span>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <button class="btn btn-outline btn-sm" *ngIf="f.estado === 'completada'"
                              (click)="toggleFaseExpandida(f.idFase)">
                        {{ faseExpandida === f.idFase ? '‚ñ≤ Ocultar' : 'üëÅÔ∏è Ver Evaluaciones' }}
                      </button>
                      <button class="btn btn-outline btn-sm"
                              *ngIf="f.estado === 'programada' && f.evaluaciones && f.evaluaciones.length > 0"
                              (click)="irEvaluar(f.evaluaciones![0].idReunion)">
                        ‚úèÔ∏è Evaluar
                      </button>
                    </div>
                  </td>
                </tr>

                <!-- SUB-TABLA DE EVALUACIONES -->
                <tr *ngIf="faseExpandida === f.idFase && f.evaluaciones && f.evaluaciones.length > 0">
                  <td colspan="7" class="subrow-cell">
                    <div class="sub-table-wrapper">
                      <div class="sub-table-title">Evaluaciones de: {{ f.nombreFase }}</div>
                      <table class="table sub-table">
                        <thead>
                        <tr>
                          <th>Evaluador</th><th>Fecha</th><th>Calificaci√≥n</th>
                          <th>Observaciones</th><th>Firma</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr *ngFor="let ev of f.evaluaciones">
                          <td>{{ ev.nombreEvaluador }}</td>
                          <td>{{ ev.fechaEvaluacion }}</td>
                          <td><strong>{{ ev.calificacionFinal | number:'1.1-1' }}/5.0</strong></td>
                          <td>{{ ev.observaciones }}</td>
                          <td>
                            <span class="badge success" *ngIf="ev.confirmada">‚úì Confirmada</span>
                          </td>
                        </tr>
                        </tbody>
                        <tfoot>
                        <tr class="promedio-row">
                          <td colspan="2"><strong>PROMEDIO FINAL</strong></td>
                          <td><strong style="color: #00A63E;">
                            {{ getPromedioFase(f) | number:'1.1-1' }}/5.0
                          </strong></td>
                          <td colspan="2"></td>
                        </tr>
                        </tfoot>
                      </table>
                    </div>
                  </td>
                </tr>
              </ng-container>
              </tbody>

              <tfoot>
              <tr class="total-row">
                <td colspan="2"><strong>CALIFICACI√ìN TOTAL</strong></td>
                <td>‚Äî</td>
                <td><strong class="total-valor">{{ calificacionTotal | number:'1.1-1' }} / 100</strong></td>
                <td colspan="3"></td>
              </tr>
              </tfoot>
            </table>
          </div>
        </div>

        <!-- DECISI√ìN FINAL -->
        <div class="card" [class.disabled-card]="!procesoCompleto">
          <div class="card-header">
            <h3 class="card-title">Decisi√≥n Final del Comit√©</h3>
            <span class="badge" [ngClass]="procesoCompleto ? 'warning' : 'default'">
              {{ procesoCompleto ? 'Disponible' : 'Pendiente' }}
            </span>
          </div>

          <div class="alert info" *ngIf="!procesoCompleto">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
            </svg>
            <div>
              <strong>Informaci√≥n</strong>
              <p>La decisi√≥n final estar√° disponible una vez que se completen todas las fases del proceso.</p>
            </div>
          </div>

          <div [class.blurred]="!procesoCompleto">
            <div class="form-group">
              <label>Decisi√≥n <span class="required">*</span></label>
              <select class="form-select" [(ngModel)]="decision"
                      [disabled]="!procesoCompleto" style="max-width: 400px;">
                <option value="">Seleccionar...</option>
                <option *ngFor="let d of decisiones" [value]="d.value">{{ d.label }}</option>
              </select>
            </div>
            <div class="form-group">
              <label>Justificaci√≥n de la Decisi√≥n <span class="required">*</span></label>
              <textarea class="form-textarea" [(ngModel)]="justificacion"
                        [disabled]="!procesoCompleto"
                        placeholder="Fundamente la decisi√≥n del comit√©..."></textarea>
            </div>
          </div>

          <div class="footer-actions">
            <button class="btn btn-primary" (click)="guardarDecision()"
                    [disabled]="!procesoCompleto || isSaving">
              <svg *ngIf="isSaving" class="spinner-icon" fill="none" stroke="currentColor"
                   viewBox="0 0 24 24" width="18" height="18">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
              </svg>
              {{ isSaving ? 'Guardando...' : 'üíæ Guardar Decisi√≥n Final' }}
            </button>
          </div>
        </div>

      </ng-container>
    </ng-container>

  </div>
</div>
